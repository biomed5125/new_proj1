@* Pages/Lab/_Layout.cshtml *@
@using Microsoft.AspNetCore.Mvc.RazorPages
@inject Microsoft.AspNetCore.Mvc.Rendering.IHtmlHelper Html

@functions {
    string ActiveClass(string pathStartsWith)
    {
        var p = Context.Request.Path.Value?.ToLowerInvariant() ?? "";
        return p.StartsWith(pathStartsWith.ToLowerInvariant()) ? "active" : "";
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@(ViewData["Title"] ?? "HMS · Lab")</title>

    <!-- Bootswatch Cosmo (Bootstrap 5.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/cosmo/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <style>
        /* --- Layout --- */
        body {
            background: #f7f8fa;
        }

        .app-shell {
            min-height: 100vh;
        }

        .app-sidebar {
            width: 240px;
            border-right: 1px solid rgba(0,0,0,.08);
            background: #fff;
        }

        .app-main {
            flex: 1 1 auto;
            min-width: 0;
        }

        .brand {
            font-weight: 700;
            letter-spacing: .2px;
        }

        .nav-section {
            font-size: .78rem;
            color: #9aa0a6;
            text-transform: uppercase;
            margin: .75rem 0 .25rem;
        }

        /* --- Sidebar nav --- */
        .side-link {
            display: flex;
            align-items: center;
            gap: .5rem;
            padding: .5rem .75rem;
            border-radius: .5rem;
            color: #334155;
            text-decoration: none;
        }

            .side-link:hover {
                background: #f1f5f9;
                text-decoration: none;
            }

            .side-link.active {
                background: #e7f1ff;
                color: #0b5ed7;
                font-weight: 600;
            }

        /* --- Cards (KPI) --- */
        .kpi-card {
            background: #fff;
            border: 1px solid rgba(0,0,0,.06);
            border-radius: .75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,.04);
        }

        .kpi-value {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .kpi-label {
            color: #6b7280;
            font-size: .9rem;
        }

        /* --- Tables --- */
        .table {
            background: #fff;
            border: 1px solid rgba(0,0,0,.06);
            border-radius: .5rem;
            overflow: hidden;
        }

            .table thead th {
                background: #f8fafc;
                font-weight: 600;
            }

        .badge-soft {
            background: rgba(25,135,84,.12);
            color: #198754;
            font-weight: 600;
        }
    </style>

    @RenderSection("Head", required: false)
</head>
<body>
    <div class="app">
        <!-- Sidebar (unchanged classes) -->
        <aside class="lab-sidebar d-none d-md-flex flex-column p-3">
            <div class="lab-brand mb-4">HMS · Lab . Module</div>

            <small class="text-uppercase-50 mb-2" style="opacity:.7">Add Requests</small>
             <nav class="nav flex-column lab-nav mb-3">
                <a class="nav-link @(Context.Request.Path.Value?.Equals("/lab", StringComparison.OrdinalIgnoreCase) == true ? "active" : "")" href="/lab">New File</a>
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/lab/patients") == true ? "active" : "")" href="/lab/patients">Patients</a>
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/lab/doctors") == true ? "active" : "")" href="/lab/doctors">Doctors</a>                
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/lab/orders/new") == true ? "active" : "")" href="/lab/orders/new">New Request</a>
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/lab/labrequests") == true ? "active" : "")" href="/lab/labrequests">Pending Requests</a>
            </nav>

            <small class="text-uppercase-50 mb-2" style="opacity:.7">Overview</small>
            <nav class="nav flex-column lab-nav mb-3">
                <a class="nav-link @(Context.Request.Path.Value?.Equals("/lab", StringComparison.OrdinalIgnoreCase) == true ? "active" : "")" href="/lab">Lab Dashboard</a>
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/lab/samples") == true ? "active" : "")" href="/lab/samples">Samples</a>
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/lab/orders") == true ? "active" : "")" href="/lab/orders">Orders</a>
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/lab/results") == true ? "active" : "")" href="/lab/results">Results</a>                
            </nav>

            <small class="text-uppercase-50 mb-2" style="opacity:.7">Catalog</small>
            <nav class="nav flex-column lab-nav mb-3">
                <a class="nav-link @(Context.Request.Path.Value?.Contains("/lab/catalog/tests") == true ? "active" : "")" href="/lab/catalog/tests">Lab Tests</a>
                <a class="nav-link @(Context.Request.Path.Value?.Contains("/lab/catalog/panels") == true ? "active" : "")" href="/lab/catalog/panels">Lab Test Panels</a>
                <a class="nav-link @(Context.Request.Path.Value?.Contains("/lab/catalog/instrument-maps") == true ? "active" : "")" href="/lab/catalog/instrument-maps">Instrument Maping</a>
            </nav>

            <small class="text-uppercase-50 mb-2" style="opacity:.7">Tools</small>
            <nav class="nav flex-column lab-nav">
                <a class="nav-link @(Context.Request.Path.Value?.StartsWith("/comm/bench") == true ? "active" : "")" href="/comm/bench">Comm Bench</a>
            </nav>
            <!-- _LayoutLab.cshtml : inside the left sidebar (anywhere under Tools) -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-body p-2">
                    <label class="form-label small mb-1">Scan Accession / Order</label>
                    <input class="form-control form-control-sm" id="labScanBox" placeholder="ACC-... or ORD-..." autocomplete="off">
                </div>
            </div>

        </aside>

        <!-- Main scrollable area -->
        <main class="lab-main">
            <div class="container-xxl py-3">  @RenderBody()
            </div>
        </main>
    </div>
    <script>
        (function(){
          async function handleScan(v){
            v = (v||'').trim();
            if(!v) return;
            try {
              if (v.startsWith('ACC-')) {
                // optional: mark a scan/receive event if you expose it (see API below)
                try { await fetch(`/api/barcodes/scan/${encodeURIComponent(v)}`, { method:'POST' }); } catch {}
                // jump to labels or results entry
                location.href = `/lab/results/enter?acc=${encodeURIComponent(v)}`;
              } else if (v.startsWith('ORD-')) {
                // open order detail – your “Order.cshtml” expects ?id=<requestId>.
                // If you don’t have requestId, you can make a small API that resolves it from OrderNo.
                location.href = `/lab/labrequests`; // or make a small resolver later
              }
            } catch {}
          }
          const box = document.getElementById('labScanBox');
          box?.addEventListener('keydown', e=>{
            if(e.key==='Enter'){ handleScan(e.target.value); e.target.value=''; }
          });
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>

