@page "/lab/labrequests"
@model HMS.Api.Pages.Lab.LabRequests.OrdersIndexModel
@{
    Layout = "_LayoutLab";
    ViewData["Title"] = "Pending Requests";
}
<div class="page-header">
  <h2 class="mb-1">Lab Requests</h2>
  <div class="text-muted small">Latest 200 orders.</div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Patient</th>
          <th>Tests</th>
          <th>Source</th>
          <th>At</th>
          <th>OrderNo</th>
          <th style="width:160px">Actions</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var r in Model.Items)
        {
          <tr>
            <td>@r.PatientDisplay</td>
            <td>
              @if (!string.IsNullOrWhiteSpace(r.Tests))
              {
                foreach (var c in r.Tests.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                {
                  <span class="badge text-bg-light me-1">@c</span>
                }
              }
              else { <span class="text-muted">—</span> }
            </td>
            <td>@(string.IsNullOrWhiteSpace(r.Source) ? "-" : r.Source)</td>
            <td>@r.AtLocal.ToString()</td>
            <td><a class="fw-semibold" href="/lab/dashboard/order?id=@r.RequestId">@r.OrderNo</a></td>
            <td>
              <div class="btn-group btn-group-sm">
                <a class="btn btn-outline-primary" href="/lab/dashboard/order?id=@r.RequestId">Open</a>
                <a class="btn btn-outline-secondary" href="/lab/labels/@r.OrderNo" target="_blank">Copy</a>
                <button class="btn btn-outline-danger js-del" data-id="@r.RequestId">Delete</button>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

@section Scripts{
<script>
document.addEventListener('click', async e=>{
  const b=e.target.closest('.js-del'); if(!b) return;
  if(!confirm('Delete this request?')) return;
  const id=b.dataset.id;
  const r=await fetch(`/api/v1/lab/requests/${id}`, {method:'DELETE'});
  if(!r.ok){ alert(await r.text()); return; }
  location.reload();
});
</script>
}
